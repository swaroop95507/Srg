trigger:
  branches:
    include:
      - main

pool:
  name: SelfHosted

steps:
  - checkout: self
    persistCredentials: false

  - powershell: |
      $ErrorActionPreference = "Stop"

      Write-Host "Publishing static site to gh-pages..."

      git config user.email "azure-pipelines@local"
      git config user.name "Azure Pipelines"

      # clean publish folder
      if (Test-Path publish) { Remove-Item publish -Recurse -Force }
      New-Item -ItemType Directory -Path publish | Out-Null

      # Copy everything except .git, publish, and yaml
      robocopy .\ publish /E /XD .git publish /XF azure-pipelines.yml | Out-Null

      cd publish

      git init
      git checkout -b gh-pages

      $repo = "$(Build.Repository.Name)"
      git remote add origin "https://$(GITHUB_PAT)@github.com/$repo.git"

      git add -A
      git commit -m "Deploy GitHub Pages (Build $(Build.BuildId))" 2>$null
      if ($LASTEXITCODE -ne 0) { Write-Host "No changes to commit (ok)" }

      git push -u origin gh-pages --force
    env:
      GITHUB_PAT: $(GITHUB_PAT)
    displayName: "Deploy to GitHub Pages (Windows agent)"
